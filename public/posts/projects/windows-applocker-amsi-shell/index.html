<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bypassing Applocker&#43;AMSI&#43;Defender in 2024</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />

<link rel="stylesheet" href="/application.57540b64386ae720ce455fa77a3b38d1c126c3cf3fe826f3818725366478a864.css" integrity="sha256-V1QLZDhq5yDORV&#43;nejs40cEmw88/6CbzgYclNmR4qGQ=" />





  

  
  
  
    
  
  

  <link rel="icon" type="image/png" href="/images/site/favicon_hu15095690576186281638.png" />

<meta property="og:url" content="http://localhost:1313/posts/projects/windows-applocker-amsi-shell/">
  <meta property="og:site_name" content="Nathan May">
  <meta property="og:title" content="Bypassing Applocker&#43;AMSI&#43;Defender in 2024">
  <meta property="og:description" content="Sample post with multiple images, embedded video etc.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-06-08T08:06:25+06:00">
    <meta property="article:modified_time" content="2020-06-08T08:06:25+06:00">

    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Bypassing Applocker&#43;AMSI&#43;Defender in 2024">
  <meta name="twitter:description" content="Sample post with multiple images, embedded video etc.">

    
    
<meta name="description" content="Sample post with multiple images, embedded video etc." />


    

    




<script>
      theme = localStorage.getItem('theme-scheme') || localStorage.getItem('darkmode:color-scheme') || 'light';
      if (theme == 'system') {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          theme = 'dark';
        } else {
          theme = 'light';
        }
      }
      document.documentElement.setAttribute('data-theme', theme);
    </script>
  </head>

  <body class="type-posts kind-page" data-bs-spy="scroll" data-bs-target="#TableOfContents" data-bs-offset="80">
    <div class="container-fluid bg-secondary wrapper">
      
      
    















  


  




  
  
    
  
  



  
  
    
  
  







  




  




  


<nav class="navbar navbar-expand-xl top-navbar shadow " id="top-navbar">
  <div class="container">
    
    <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button">
      <i data-feather="sidebar"></i>
    </button>
    
    <a class="navbar-brand" href="/">
      
        <img src="/images/site/main-logo_hu15095690576186281638.png" id="logo" alt="Logo">
      Nathan May</a>
    <button
      class="navbar-toggler navbar-light"
      id="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#top-nav-items"
      aria-label="menu"
    >
      <i data-feather="menu"></i>
    </button>

    <div class="collapse navbar-collapse dynamic-navbar" id="top-nav-items">
      <ul class="nav navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="/#home">Home</a>
        </li>
        
          
          
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#about">About</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#skills">Competitions/CTFs</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#experiences">Experiences</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#projects">Projects</a>
                </li>
              
            
            
              
              
            
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">More</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                
                  
                    
                    
                  
                  
                    
                    
                  
                  
                    
                    
                  
                  
                    
                    
                  
                  
                    
                    
                      <a class="dropdown-item" href="/#recent-posts">Recent Posts</a>
                    
                  
              </div>
            </li>
          
        
        
          <div id="top-navbar-divider"></div>
        
        
          <li class="nav-item">
            <a class="nav-link" id="blog-link" href="/posts">Posts</a>
          </li>
        
        
        
            
        
            
              <li class="nav-item">
                <a class="nav-link" href="https://nathanjmay.com"></a>
              </li>
            
        
        
        
      </ul>
    </div>
  </div>
  
  
    <img src="/images/site/main-logo_hu15095690576186281638.png" class="d-none" id="main-logo" alt="Logo">
  
  
    <img src="/images/site/inverted-logo_hu9607983305513964252.png" class="d-none" id="inverted-logo" alt="Inverted Logo">
  
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <form class="mx-auto" method="get" action="/search">
          <input type="text" name="keyword" value="" placeholder="Search" data-search="" id="search-box" />
        </form>
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="/posts/" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
    
    
  
  
    
    <li>
      <i data-feather="minus-circle"></i><a class="active list-link" href="/posts/projects/"> Projects</a>
      
      <ul class="active">
        
  
  
  
  
    
    
  
  
    
    <li><a class="active list-link" href="/posts/projects/windows-applocker-amsi-shell/" title="Bypassing Applocker&#43;AMSI&#43;Defender in 2024">Bypassing Applocker&#43;AMSI&#43;Defender in 2024</a></li>
  

  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/projects/pfsensevpn/" title="Home VPN Setup with PFSense">Home VPN Setup with PFSense</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i data-feather="plus-circle"></i><a class=" list-link" href="/posts/resources/"> Resources</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/resources/fav/" title="My Favorite Resources">My Favorite Resources</a></li>
  

  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/resources/pentest/" title="PenTest&#43;">PenTest&#43;</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i data-feather="plus-circle"></i><a class=" list-link" href="/posts/tools/"> Tools</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/tools/meterpreter/" title="Meterpreter">Meterpreter</a></li>
  

  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/tools/opencanary/" title="OpenCanary">OpenCanary</a></li>
  


      </ul>
    </li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(/posts/projects/windows-applocker-amsi-shell/images/vpn.jpg);'>
      </div>

      
      <div class="page-content">
        
        <div class="author-profile ms-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/author/profile_hu800106212459491830.png' alt="Author Image">
          <h5 class="author-name">Nathan May</h5>
          <p class="text-muted">Monday, June 8, 2020 | 2 minutes</p>
        </div>
        
        
        <div class="title">
          <h1>Bypassing Applocker&#43;AMSI&#43;Defender in 2024</h1>
        </div>

        

        
          <div class="tags">
  <ul style="padding-left: 0;">
    
  </ul>
</div>

        
        <div class="post-content" id="post-content">
          <h3 id="introduction">Introduction</h3>
<p>Malware development and EDR/AV evasion is a constant cat and mouse game. Evasion techniques are discovered, popularized, and then shortly detected. This is a combination of several techniques learned while taking Offsec&rsquo;s Offensive Security Experienced Professional (OSEP) course. As of July 2024, this method will successfully run Malicious PowerShell on a fully patched Windows system with Applocker, AMSI, Constrained Language Mode (CLM), and Defender. PowerShell can then be used to perform recon like WinPEAS.ps1, or run stagers for C2 malware.</p>
<h3 id="primary-components">Primary Components</h3>
<p>Several techniques will be used to successfully bypass the various protections in place. I will organize the code by the component that it will be bypassing.</p>
<ul>
<li>InstallUtil Uninstall Method</li>
<li>Sleep check + encryption</li>
<li>Creating a new Powershell Runspace</li>
<li>Breaking AMSI through memory patching.</li>
</ul>
<h4 id="bypassing-applocker">Bypassing Applocker</h4>
<p>The first defense that needs to be bypassed is AppLocker. Everything else is dependent on the binary executing which will be blocked without some sort of bypass. The method I use in this code utilizes the Windows binary InstallUtil.exe. This binary is meant to help install and uninstall applications, and is allowed by default AppLocker rules because it is signed by Microsoft. By creating an Uninstall method in our code, we can execute the method by running our binary via InstallUtil.exe attempting to &lsquo;uninstall&rsquo; the application.</p>
<h4 id="bypassing-defender">Bypassing Defender</h4>
<p>Now that we are able to run the binary, we need to make it challenging for Defender to review the application for malicious activity. Windows Defender is relatively easy to bypass currently, and a simple sleep check and encryption will get the job done.</p>
<h4 id="bypassing-constrained-language-mode-clm">Bypassing Constrained Language Mode (CLM)</h4>
<p>PowerShell can be restricted to prevent calling .NET limiting PowerShell&rsquo;s capability for an attacker. Constrained Language Mode only monitors the runspace created by executing the PowerShell.exe binary. To bypass this, we can &lsquo;create our own&rsquo; PowerShell by using the same DLLs that PowerShell does. This new Runspace will not be restricted by CLM.</p>
<h4 id="bypassing-amsi">Bypassing AMSI</h4>
<p>We can now break AMSI by memory patching. AMSI is currently fail open, so by interfering with the hook, commands will continue to work unmonitored. There are many AMSI bypasses, so I will leave this specific section of code out of this writeup, but you can include whichever works best for you.</p>
<h3 id="other-resources">Other Resources</h3>
<ul>
<li><a href="https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/md/Installutil.exe.md" target="_blank" rel="noopener">https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/md/Installutil.exe.md</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/amsi-bypass-patching-technique" target="_blank" rel="noopener">https://www.cyberark.com/resources/threat-research-blog/amsi-bypass-patching-technique</a></li>
</ul>

        </div>

        
        <div class="row ps-3 pe-3">
        
          <div class="col-md-6 share-buttons">
          
            <strong>Share on:</strong>
            
            <a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fprojects%2fwindows-applocker-amsi-shell%2f" target="_blank">
              <i class="fab fa-facebook"></i>
            </a>
            
            
                <a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fprojects%2fwindows-applocker-amsi-shell%2f&text=Bypassing%20Applocker%2bAMSI%2bDefender%20in%202024&via=Nathan%20May" target="_blank">
                  <i class="fab fa-twitter"></i>
                </a>
            
            
                <a  class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fprojects%2fwindows-applocker-amsi-shell%2f&title=Bypassing%20Applocker%2bAMSI%2bDefender%20in%202024" target="_blank">
                  <i class="fab fa-reddit"></i>
                </a>
            
            
            
            
                <a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fprojects%2fwindows-applocker-amsi-shell%2f&title=Bypassing%20Applocker%2bAMSI%2bDefender%20in%202024" target="_blank">
                  <i class="fab fa-linkedin"></i>
                </a>
            
            
             
            
                 <a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Bypassing%20Applocker%2bAMSI%2bDefender%20in%202024 http%3a%2f%2flocalhost%3a1313%2fposts%2fprojects%2fwindows-applocker-amsi-shell%2f" target="_blank">
                  <i class="fab fa-whatsapp"></i>
                </a>
            
            
                <a class="btn icon-button" href="mailto:?subject=Bypassing%20Applocker%2bAMSI%2bDefender%20in%202024&body=http%3a%2f%2flocalhost%3a1313%2fposts%2fprojects%2fwindows-applocker-amsi-shell%2f" target="_blank">
                  <i class="fas fa-envelope-open-text"></i>
                </a>
            
          
          </div>

        
        
          
            
          
          <div class="col-md-6 btn-improve-page">
             
               <a href="https://github.com/hugo-toha/hugo-toha.github.io/edit/main/content/posts/Projects/windows-applocker-amsi-shell/index.md" title="Improve this page" target="_blank" rel="noopener">
            
                <i class="fas fa-code-branch"></i>
                Improve this page
              </a>
          </div>
        
        </div>



      
      <hr />
        







  





  
    
    
  
  

  
  

  
  

  
  

  
  

  
  


<div class="row next-prev-navigator">
  
  
      
      
      <div class="col-md-12 next-article">
        <a href="/posts/projects/pfsensevpn/" title="Home VPN Setup with PFSense" class="btn filled-button">
          <div>Next <i class="fas fa-chevron-circle-right"></i></div>
          <div class="next-prev-text">Home VPN Setup with PFSense</div>
        </a>
      </div>
    
</div>

      <hr />

      
      

      
      

      </div>
    </div>
  </div>
  
  <a id="scroll-to-top" class="btn" type="button" data-bs-toggle="tooltip" data-bs-placement="left" title="Scroll to top">
    <i class="fas fa-chevron-circle-up"></i>
  </a>
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center ps-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#primary-components">Primary Components</a>
          <ul>
            <li><a href="#bypassing-applocker">Bypassing Applocker</a></li>
            <li><a href="#bypassing-defender">Bypassing Defender</a></li>
            <li><a href="#bypassing-constrained-language-mode-clm">Bypassing Constrained Language Mode (CLM)</a></li>
            <li><a href="#bypassing-amsi">Bypassing AMSI</a></li>
          </ul>
        </li>
        <li><a href="#other-resources">Other Resources</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    
    












  
  
    
  

  
  
    
  

  
  
    
  

  
  
    
    
      
    
  


  
  
  
    
  

  
  
  

  
  
  
    
  
  

  
  
  

  <footer id="footer" class="container-fluid text-center align-content-center footer pb-2">
    <div class="container pt-5">
      <div class="row text-start">
        
        <div class="col-md-4 col-sm-12">
          <h5>Navigation</h5>
          
          <ul>
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#about">About</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#skills">Competitions/CTFs</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#experiences">Experiences</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#projects">Projects</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#recent-posts">Recent Posts</a>
                </li>
              
            
              
                
              
                
              
            
          </ul>
          
        </div>
        
        
        
        
      </div>
    </div>
    
    <hr />
    <div class="container">
      <p id="disclaimer"><strong>Liability Notice:</strong> Get disclaimed.</p>
    </div>
    
    
    <hr />
    <div class="container">
      <div class="row text-start">
        <div class="col-md-4">
          <a id="theme" href="https://github.com/hugo-toha/toha" target="_blank" rel="noopener">
            <img src="/images/theme-logo_hu16779671404603505019.png" alt="Toha Theme Logo">
            Toha
          </a>
        </div>
        <div class="col-md-4 text-center">Â© 3005 Copyright.</div>
        <div class="col-md-4 text-end">
          <a id="hugo" href="https://gohugo.io/" target="_blank" rel="noopener">Powered by
          <img
            src="/images/hugo-logo.svg"
            alt="Hugo Logo"
            height="18"
          />
          </a>
        </div>
      </div>
    </div>
    
  </footer>


    <script src="/application.1ae86b5a2e9486eadf1498b7dcbfc587c8cf4185f7cd2f9e83fc7977fe036011.js" integrity="sha256-GuhrWi6UhurfFJi33L/Fh8jPQYX3zS&#43;eg/x5d/4DYBE=" defer></script>


    
     

    
    

</body>
</html>
